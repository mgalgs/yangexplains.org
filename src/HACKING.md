## Setting up a local dev environment

```
cd /path/to/yangexplains.org/src
```

and create a file named `env_file` with the following content:

```
SECRET_KEY=<redacted>
FLASK_ENV=development
POSTGRES_USER=postgres
POSTGRES_PASSWORD=whatever_you_want
POSTGRES_HOST=db
POSTGRES_DB=postgres
GOOGLE_OAUTH_CLIENT_ID=<redacted>
GOOGLE_OAUTH_CLIENT_SECRET=<redacted>
```

See
[this](https://realpython.com/flask-google-login/#creating-a-google-client)
tutorial for creating a Google oauth app for testing.

You can generate a value for `SECRET_KEY` with:

```
python -c 'import secrets; print(secrets.token_urlsafe(16))'
```

(assumes `python` 3.6 or later)

Then start the app:

```
./composectl up
```

(`composectl` is a trivial wrapper around `docker-compose` which sets the
user/group inside the container to the current user)

In another terminal, apply the database schema:

```
./composectl exec flaskapp sh -c "cd /app/yangify; flask db upgrade"
```

The app should now be running on http://localhost:5000 with hot-reloading
of the backend and frontend code enabled.  Now just start hacking!

## Data model changes

### Schema changes

If you change any of the data model definitions you'll need to generate a
migration script:

```
./composectl exec flaskapp sh -c "cd /app/yangify; flask db migrate"
```

which you'll then need to apply with:

```
./composectl exec flaskapp sh -c "cd /app/yangify; flask db upgrade"
```

### Data migrations

If you need to perform some kind of data migration (backfilling new
columns, etc.) you can generate an empty migration with:

```
./composectl exec flaskapp sh -c "cd /app/yangify; flask db revision"
```

You'll be left with an empty migration file which you can fill in with
custom migration code.  See
[this](https://stackoverflow.com/q/24612395/209050) SO question for an
example.

## Adding Python packages

If you need to add a Python package, start the app with `./composectl up`
and then run:

```
docker exec --user=root src_flaskapp_1 pip install SOME_PACKAGE
docker exec --user=root src_flaskapp_1 sh -c "pip freeze --local > requirements.txt"
```

(note that you might have a different autogenerated name than
`src_flaskapp_1` -- see `docker ps` to get the exact name)

## Adding Javascript packages

If you need to add a javascript package, start the app with
`./composectl up` and then run:

```
docker exec src_frontend_1 sh -c "cd /code; npm install SOME_PACKAGE --save"
```

(note that you might have a different autogenerated name than
`src_frontend_1` -- see `docker ps` to get the exact name)

## Running in production

For now we're just running this baby on a single server using
`docker-compose`.  In production we set `FLASK_ENV=production` in
`env_file`, which causes `composectl` to grab some additional services
(namely `nginx`).

`nginx` serves as a reverse proxy for `flask` (which is run under
`gunicorn` in production, see `./backend/start.sh`) as well as serving
static files from `./collectstatic/output`.

We have to run `./collectstatic.sh` any time there's a change to static
files.  What `./collectstatic.sh` does:

- Collects up the static files from `./backend/yangify/static`
- Adds a hash to the filename and copies it to `./collectstatic/output`
- Creates a manifest json file to map non-hashed filenames to the hashed
  ones, and places that in `./collectstatic/output`.
